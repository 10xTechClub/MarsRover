<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enhanced Mars Rover Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%); 
      color: #fff; min-height: 100vh; overflow-x: hidden;
    }
    .header { 
      background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); 
      padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); 
      display: flex; justify-content: space-between; align-items: center;
    }
    .header h1 { font-size: 1.3rem; font-weight: 300; }
    .status { padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease; }
    .status.connected { background: #10b981; }
    .status.disconnected { background: #ef4444; }
    .status.reconnecting { background: #f59e0b; animation: pulse 1s infinite; }

    .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
    .card { background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .card h3 { margin-bottom: 1rem; font-size: 1.05rem; font-weight: 400; opacity: 0.9; }
    .mode-selector { display:flex; gap:1rem; justify-content:center; margin-bottom:1rem }
    .mode-btn { padding: .6rem 1rem; border-radius:10px; border:2px solid #374151; background:transparent; color:#9ca3af; cursor:pointer; }
    .mode-btn.active { background:#10b981; border-color:#10b981; color:white; }
    .joystick { width:140px; height:140px; background: radial-gradient(circle, #1f2937 0%, #111827 70%); border:3px solid #374151; border-radius:50%; position:relative; }
    .joystick-dot { width:25px;height:25px;border-radius:50%; background:#10b981; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); box-shadow:0 2px 8px rgba(16,185,129,0.4); transition:all .08s ease; }
    .camera-feed { width:100%; aspect-ratio:4/3; border-radius:12px; object-fit:cover; background:#1f2937; }
    .sensor-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap:1rem; margin-top:1rem; }
    .sensor { text-align:center; padding:1rem; background: rgba(255,255,255,0.05); border-radius:10px; border:1px solid rgba(255,255,255,0.1); }
    .sensor-value { font-size:1.8rem; font-weight:600; background:linear-gradient(45deg,#10b981,#059669); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent; color:transparent; }
    .sensor-label { font-size:0.8rem; opacity:0.7; margin-top:0.5rem; }
    .auto-status { background: linear-gradient(45deg,#3b82f6,#2563eb); padding:1rem; margin:1rem; border-radius:12px; box-shadow:0 4px 20px rgba(59,130,246,0.3); font-weight:500; text-align:center; display:none; }
    .auto-status.visible { display:block; }
    .auto-debug { background: rgba(0,0,0,0.3); padding:1rem; border-radius:8px; font-family:monospace; font-size:.8rem; max-height:200px; overflow:auto; border:1px solid rgba(255,255,255,0.1); }
    .btn { background: linear-gradient(45deg,#3b82f6,#2563eb); border:none; padding:.6rem; border-radius:10px; color:white; cursor:pointer; }
    .danger { color:#ef4444 !important; }
    .emergency-stop { position: fixed; top: 50%; right: 20px; transform: translateY(-50%); background: #ef4444; border:none; color:white; padding:1rem 1.2rem; border-radius:50px; font-size:1.0rem; cursor:pointer; z-index:1000; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
    @media (max-width:768px){ .container{ grid-template-columns:1fr } .emergency-stop{ position: static; display:block; margin:1rem auto } }
  </style>
</head>
<body>
  <button class="emergency-stop" onclick="emergencyStop()">üõë EMERGENCY STOP</button>
  <div class="header">
    <h1>üåñ Enhanced Mars Rover Control</h1>
    <div id="connectionStatus" class="status disconnected">DISCONNECTED</div>
  </div>

  <div class="container">
    <div class="card">
      <h3>üéÆ Control Mode</h3>
      <div class="mode-selector">
        <button id="manualMode" class="mode-btn active">Manual</button>
        <button id="autoMode" class="mode-btn">Autonomous</button>
      </div>

      <div id="manualControls">
        <h3>üïπÔ∏è Movement Control</h3>
        <div style="display:flex; justify-content:center; gap:1rem; align-items:center">
          <div id="joystick" class="joystick"><div id="joystickDot" class="joystick-dot"></div></div>
        </div>
        <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:center;">
          <button class="btn" onclick="send('move:forward')">‚ñ≤ Forward</button>
          <button class="btn" onclick="send('move:left')">‚óÄ Left</button>
          <button class="btn" onclick="send('move:stop')">‚ñ† Stop</button>
          <button class="btn" onclick="send('move:right')">‚ñ∂ Right</button>
          <button class="btn" onclick="send('move:backward')">‚ñº Back</button>
        </div>
        <h3 style="margin-top:1rem">üìπ Camera Control</h3>
        <div style="display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap;">
          <button class="btn" onclick="moveCamera('tilt',10)">‚ñ≤</button>
          <button class="btn" onclick="moveCamera('pan',-10)">‚óÄ</button>
          <button class="btn" onclick="moveCamera('pan',10)">‚ñ∂</button>
          <button class="btn" onclick="moveCamera('tilt',-10)">‚ñº</button>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:.6rem;">
          <div>Pan: <span id="panAngle">90</span>¬∞</div>
          <div>Tilt: <span id="tiltAngle">90</span>¬∞</div>
        </div>
      </div>

      <div style="margin-top:1rem;" class="auto-debug">
        <div style="font-weight:bold; margin-bottom:.5rem;">Autonomous Debug Log:</div>
        <div id="debugLog">System ready...</div>
      </div>
    </div>

    <div class="card" id="cameraCard">
      <h3>üì° Live Camera Feed</h3>
      <img src="http://192.168.0.120:81/stream" class="camera-feed" id="camStream" alt="Camera Feed">
      <h3 style="margin-top:1rem">üîç Scanner Control</h3>
      <div style="display:flex; gap:.5rem;">
        <button class="btn" onclick="send('scanner:180')">Left</button>
        <button class="btn" onclick="send('scanner:90')">Center</button>
        <button class="btn" onclick="send('scanner:0')">Right</button>
      </div>
      <h3 style="margin-top:1rem">üß≤ Hall Scanner Control</h3>
      <div style="display:flex; gap:.5rem;">
        <button class="btn" onclick="send('hallscanner:55')">Up</button>
        <button class="btn" onclick="send('hallscanner:70')">Middle</button>
        <button class="btn" onclick="send('hallscanner:100')">Down</button>
      </div>
      <div id="autoStatus" class="auto-status"></div>
    </div>

    <div class="card">
      <h3>üìä Sensor Data</h3>
      <div class="sensor-grid">
        <div class="sensor distance-sensor" id="distanceSensor">
          <div class="sensor-value" id="distance">0</div>
          <div class="sensor-label">Distance (cm)</div>
        </div>
        <div class="sensor">
          <div class="sensor-value" id="temp">0</div>
          <div class="sensor-label">Temp (¬∞C)</div>
        </div>
        <div class="sensor">
          <div class="sensor-value" id="humidity">0</div>
          <div class="sensor-label">Humidity (%)</div>
        </div>
        <div class="sensor">
          <div class="sensor-value" id="light">0</div>
          <div class="sensor-label">Light (%)</div>
        </div>
        <div class="sensor">
          <div class="sensor-value" id="hall">0</div>
          <div class="sensor-label">Magnetic Field</div>
        </div>
        <div class="sensor">
          <div class="sensor-value" id="gas">0</div>
          <div class="sensor-label">Gas (MQ-135)</div>
        </div>
      </div>
      <div id="sensorAlerts" 
          style="margin-top:1rem; padding:0.75rem 1rem; border-radius:6px; display:none; font-weight:600; text-align:center;">
          <span id="alertsText">‚úÖ All sensors within safe range</span>
      </div>
    </div>
  </div>

<script>
  // ---------- Connection & State ----------
  let ws;
  const connStatus = document.getElementById("connectionStatus");
  const debugLog = document.getElementById("debugLog");
  const autoStatusBox = document.getElementById("autoStatus");
  let reconnectAttempts = 0;
  let maxReconnect = 12;
  let pingInterval = null;
  let isAutoMode = false;
  let emergencyLocked = false;

  // Sensor smoothing
  const smoothValues = {
    distance: {current:0,target:0,element:document.getElementById('distance')},
    temp: {current:0,target:0,element:document.getElementById('temp')},
    humidity: {current:0,target:0,element:document.getElementById('humidity')},
    light: {current:0,target:0,element:document.getElementById('light')},
    hall: {current:0,target:0,element:document.getElementById('hall')},
    gas: {current:0,target:0,element:document.getElementById('gas')}
  };

  function debugLogAdd(msg){
    const t = new Date().toLocaleTimeString();
    debugLog.innerHTML += `<br>[${t}] ${msg}`;
    debugLog.scrollTop = debugLog.scrollHeight;
  }

  function setConnectedState(state){
    if(state){
      connStatus.textContent = "CONNECTED";
      connStatus.className = "status connected";
    } else {
      connStatus.textContent = "DISCONNECTED";
      connStatus.className = "status disconnected";
    }
  }

  // ---------- WebSocket ----------
  function initWebSocket(){
    if (ws && ws.readyState === WebSocket.OPEN) return;
    const url = `ws://${location.hostname}:${location.port || 80}/ws`;
    debugLogAdd(`Connecting to ${url}`);
    try {
      ws = new WebSocket(url);
      ws.onopen = () => {
        reconnectAttempts = 0;
        setConnectedState(true);
        debugLogAdd('WebSocket opened');
        // keepalive ping
        if(pingInterval) clearInterval(pingInterval);
        pingInterval = setInterval(()=>{ if(ws.readyState===WebSocket.OPEN) ws.send('__ping__'); }, 5000);
        // if in auto mode, inform the rover
        if (isAutoMode) send('mode:auto');
      };
      ws.onclose = () => {
        setConnectedState(false);
        debugLogAdd('WebSocket closed');
        if(pingInterval) { clearInterval(pingInterval); pingInterval = null; }
        scheduleReconnect();
      };
      ws.onerror = (e) => {
        debugLogAdd('WebSocket error');
      };
      ws.onmessage = (evt) => {
        try {
          const data = JSON.parse(evt.data);
          // Update sensors
          if (data.distance !== undefined) smoothValues.distance.target = data.distance;
          if (data.temp !== undefined) smoothValues.temp.target = data.temp;
          if (data.humidity !== undefined) smoothValues.humidity.target = data.humidity;
          if (data.light !== undefined) smoothValues.light.target = data.light;
          if (data.hall !== undefined) smoothValues.hall.target = data.hall;
          if (data.gas !== undefined) smoothValues.gas.target = data.gas;
          if (data.pan !== undefined) document.getElementById('panAngle').textContent = data.pan;
          if (data.tilt !== undefined) document.getElementById('tiltAngle').textContent = data.tilt;

          if (data.autoStatus) {
            showAutoStatus(data.autoStatus);
            debugLogAdd(`[AUTO] ${data.autoStatus}`);
          }
          if (data.scanLeft !== undefined || data.scanCenter !== undefined || data.scanRight !== undefined) {
            const left = data.scanLeft ?? '-';
            const center = data.scanCenter ?? '-';
            const right = data.scanRight ?? '-';
            debugLogAdd(`[SCAN] L:${left} C:${center} R:${right}`);
          }

          // --- HANDLE ALERTS ---
          if (data.alerts && data.alerts.length > 0) {
            const alertsBox = document.getElementById('sensorAlerts');
            const alertsText = document.getElementById('alertsText');
            
            const alertMsg = data.alerts[0]; // Show first alert
            alertsText.textContent = alertMsg;
            
            if (alertMsg.includes("‚úÖ")) {
              alertsBox.style.background = '#10b981';
            } else {
              alertsBox.style.background = '#ef4444';
            }
            alertsBox.style.color = 'white';
            alertsBox.style.display = 'block';
          }
          // -------------------------------------

        } catch(e) {
          // non-json messages or pings ignored
        }
      };
    } catch(e){
      debugLogAdd('Exception opening WebSocket: ' + e.message);
      scheduleReconnect();
    }
  }

  function scheduleReconnect(){
    reconnectAttempts++;
    if (reconnectAttempts > maxReconnect) {
      debugLogAdd('Max reconnect attempts reached');
      setConnectedState(false);
      return;
    }
    setConnectedState(false);
    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
    connStatus.className = "status reconnecting";
    connStatus.textContent = `RECONNECTING (${reconnectAttempts})`;
    debugLogAdd(`Reconnecting in ${delay/1000}s...`);
    setTimeout(initWebSocket, delay);
  }

  function send(cmd){
    if (emergencyLocked && cmd !== 'move:stop') {
      debugLogAdd('Command blocked: emergency lock active');
      return;
    }
    if (ws && ws.readyState === WebSocket.OPEN) {
      try {
        ws.send(cmd);
      } catch(e) {
        debugLogAdd('Send failed: ' + e.message);
      }
    } else {
      debugLogAdd('Not connected, cannot send: ' + cmd);
    }
  }

  // ---------- Mode switching ----------
  document.getElementById('manualMode').addEventListener('click', ()=> setMode('manual'));
  document.getElementById('autoMode').addEventListener('click', ()=> setMode('auto'));

  function setMode(mode){
    const manualBtn = document.getElementById('manualMode');
    const autoBtn = document.getElementById('autoMode');
    const manualControls = document.getElementById('manualControls');

    if (mode === 'manual'){
      isAutoMode = false;
      manualBtn.classList.add('active');
      autoBtn.classList.remove('active');
      manualControls.style.opacity = 1;
      send('mode:manual');
      debugLogAdd('Switched to manual mode');
    } else {
      send('hallscanner:70');
      isAutoMode = true;
      manualBtn.classList.remove('active');
      autoBtn.classList.add('active');
      manualControls.style.opacity = 0.4;
      send('mode:auto');
      debugLogAdd('Switched to autonomous mode');
    }
  }

  function showAutoStatus(msg){
    autoStatusBox.textContent = `ü§ñ ${msg}`;
    autoStatusBox.classList.add('visible');
    // hide after a while for short messages
    setTimeout(()=> {
      // don't hide long ongoing statuses (basic heuristic)
      if (autoStatusBox.textContent === `ü§ñ ${msg}`) {
        autoStatusBox.classList.remove('visible');
      }
    }, 4000);
  }

  // ---------- Joystick (manual) ----------
  const joystick = document.getElementById('joystick');
  const joystickDot = document.getElementById('joystickDot');
  let lastJoystickCmd = 'stop';
  let lastJoystickTime = 0;

  function updateJoystick(clientX, clientY){
    if (isAutoMode || emergencyLocked) return;
    const now = Date.now();
    if (now - lastJoystickTime < 80) return; // throttle
    lastJoystickTime = now;

    const rect = joystick.getBoundingClientRect();
    let x = clientX - rect.left;
    let y = clientY - rect.top;
    const cx = rect.width / 2, cy = rect.height / 2;
    const dx = x - cx, dy = y - cy;
    const angle = Math.atan2(dy, dx);
    const radius = rect.width / 2 - 15;
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), radius);

    const px = cx + dist * Math.cos(angle);
    const py = cy + dist * Math.sin(angle);

    joystickDot.style.left = `${px}px`;
    joystickDot.style.top = `${py}px`;

    // map to direction
    const nx = (px / rect.width) * 2 - 1;
    const ny = (py / rect.height) * -2 + 1;

    let cmd = 'stop';
    if (Math.abs(ny) > 0.5) cmd = ny > 0 ? 'forward' : 'backward';
    else if (Math.abs(nx) > 0.5) cmd = nx > 0 ? 'right' : 'left';

    if (cmd !== lastJoystickCmd) {
      send('move:' + cmd);
      lastJoystickCmd = cmd;
    }
  }

  function resetJoystick(){
    joystickDot.style.left = '50%';
    joystickDot.style.top = '50%';
    if (!isAutoMode && lastJoystickCmd !== 'stop') {
      send('move:stop');
      lastJoystickCmd = 'stop';
    }
  }

  joystick.addEventListener('mousedown', (e)=>{
    if (isAutoMode || emergencyLocked) return;
    updateJoystick(e.clientX, e.clientY);
    function moveHandler(ev){ updateJoystick(ev.clientX, ev.clientY); }
    function upHandler(){ document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); resetJoystick(); }
    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
  });

  joystick.addEventListener('touchstart', (e)=>{
    if (isAutoMode || emergencyLocked) return;
    e.preventDefault();
    updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
    function touchMove(ev){ updateJoystick(ev.touches[0].clientX, ev.touches[0].clientY); }
    function touchEnd(){ joystick.removeEventListener('touchmove', touchMove); document.removeEventListener('touchend', touchEnd); resetJoystick(); }
    joystick.addEventListener('touchmove', touchMove);
    document.addEventListener('touchend', touchEnd);
  });

  // ---------- Camera & slider ----------
  let pan = 90, tilt = 90;
  function moveCamera(axis, delta) {
    if (isAutoMode || emergencyLocked) return;
    if (axis === 'pan') pan = Math.min(180, Math.max(0, pan + delta));
    if (axis === 'tilt') tilt = Math.min(180, Math.max(0, tilt + delta));
    document.getElementById('panAngle').textContent = pan;
    document.getElementById('tiltAngle').textContent = tilt;
    send(`camera:${pan},${tilt}`);
  }

  // ---------- Emergency stop ----------
  function emergencyStop(){
    emergencyLocked = true;
    send('move:stop');
    debugLogAdd('EMERGENCY STOP sent');
    showAutoStatus('üö® EMERGENCY STOP - Manual mode');
    setMode('manual');
    setTimeout(()=>{ emergencyLocked = false; debugLogAdd('Emergency released'); }, 2000);
  }

  // ---------- animate sensors ----------
  function animateValues(){
    for (let k in smoothValues){
      const obj = smoothValues[k];
      const diff = obj.target - obj.current;
      if (Math.abs(diff) > 0.2) {
        obj.current += diff * 0.18;
        obj.element.textContent = Math.round(obj.current);
      }
    }
    // distance highlights
    const distanceVal = smoothValues.distance.current;
    const ds = document.getElementById('distanceSensor');
    if (distanceVal < 40) ds.classList.add('danger'); else ds.classList.remove('danger');
    
    requestAnimationFrame(animateValues);
  }
  animateValues(); // Start the animation loop

  // ---------- init ----------
  window.addEventListener('load', ()=> {
    initWebSocket();
    animateValues(); // Add this line
    debugLogAdd('UI loaded');
  });

  // prevent leaving while auto active (note: server is authoritative but this helps)
  window.addEventListener('beforeunload', (e) => {
    if (isAutoMode) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

</script>
</body>
</html>
